var ui={navbox:sui.gel("navbox"),gCount:sui.gel("gCount"),payMoney:sui.gel("payMoney"),subOrder:sui.gel("subOrder"),container:sui.gel("container"),w:null,cartstr:null,addrId:"",yajinId:"",zujinId:"",yajinPrice:0,wayId:0,deliveryTime:"",isDin:false,isRent:false,finalMax:0,AvailMax:0,Max:0,maxActive:false,AvailBal:0,IsUseAvailBal:false,TotalAmount:0,DeliveryFee:0,imgIdArr:[],count:0,qishu:1,OrderSource:2,areaCode:""};(function(a){if(a.os.ios){ui.container.classList.add("ios-scroll-bounce")}a.plusReady(function(){ui.OrderSource=plus.os.name=="Android"?2:3;ui.cartstr=plus.webview.currentWebview().cartIds;ui.areaCode=localStorage.getItem("areaCode_cayica")||"";setTimeout(function(){ui.w=sui.wait("请稍候...");sui.request("Order/ConfirmOrder",{cartstr:ui.cartstr,areaCode:ui.areaCode},true,function(g){if(g){var n=g.IsPass;if(n){ui.TotalAmount=g.ReturnObject.TotalAmount;ui.finalMax=Math.floor(g.ReturnObject.MaxFenqiAmount);ui.AvailMax=Math.floor(g.ReturnObject.AvailDepositAmount);ui.Max=Math.min(ui.finalMax,ui.AvailMax);ui.AvailBal=g.ReturnObject.AvailBal;ui.DeliveryFee=g.ReturnObject.DeliveryFee;var q={ShouHuoAddress:g.ReturnObject.ShouHuoAddress,ProductList:g.ReturnObject.ProductList,HasQuan:g.ReturnObject.HasQuan,addrMessage:g.ReturnObject.CreateAddressMessage};var l=['<div class="mui-table-view-cell bg"><a class="mui-navigate-right padaddr" data="addr">'];if(q.ShouHuoAddress&&JSON.stringify(q.ShouHuoAddress)!=="{}"){ui.addrId=q.ShouHuoAddress.Id;ui.areaCode=q.AreaCode;localStorage.setItem("areaCode_cayica",ui.areaCode);l.push('<p class="name">'+q.ShouHuoAddress.ShouHuoRen+'<span class="mobile">'+q.ShouHuoAddress.Phone+'</span></p><p class="address"><span class="mui-icon iconfont icon-dizhi1"></span>'+q.ShouHuoAddress.Area+q.ShouHuoAddress.Address+"</p>")}else{l.push('<p><span class="mui-icon iconfont icon-dizhi1"></span>您还没有添加收货地址，快去添加吧~</p>')}l.push('</a></div><ul class="mui-table-view list">');var d=q.ProductList.length;for(var h=0;h<d;h++){ui.count+=q.ProductList[h].BuyNum;var f=sui.unique(6);ui.imgIdArr.push({id:f,imgurl:q.ProductList[h].ProductImg});l.push('<li class="mui-table-view-cell white"><img src="../images/hand.png" id="'+f+'"><div class="order_tit"><span class="tit">'+q.ProductList[h].ProductName+"</span>");var e=q.ProductList[h].ProductAttribute;var p="";if(!sui.IsNullOrEmpty(e)){e=JSON.parse(e||"[]");var k=e.length;for(var o=0;o<k;o++){if(o==2){break}p+=e[o].AttrName+" "+e[o].AttrVal+" "}}l.push('<span class="guige">'+p+"</span>");var b="押金";switch(q.ProductList[h].SaleType){case 1:ui.isRent=true;break;case 2:b="售价";break;case 3:ui.isRent=true;b="定金";break;default:break}l.push("<span>"+b+" ¥"+sui.rmoney(q.ProductList[h].Price)+'</span> </div> <span class="mui-badge ">×'+q.ProductList[h].BuyNum+"</span></li>")}l.push('</ul><ul class="mui-table-view"><li class="mui-table-view-cell" data="com" data-v="time"><a class="mui-navigate-right">送货时间 <span class="mui-badge badge" data="sendTime"></span></a>');l.push('</li><li class="mui-table-view-cell" data="com" data-v="quan"><a class="mui-navigate-right">优惠券 <span class="mui-badge badge" data="quan">'+(q.HasQuan?"":"无可用优惠券")+"</span></a></li>");l.push('<li class="mui-table-view-cell white">账户可用余额¥'+sui.rmoney(ui.AvailBal)+' <div class="mui-switch mui-switch-handle mui-switch-mini" data="toggle">  <div class="mui-switch-handle"></div></div></li>');l.push('<li class="mui-table-view-cell" data="com" data-v="selectFenQi"><a class="mui-navigate-right">押金分期 <span class="mui-badge badge" data="fenQiNum"></span></a></li>');l.push('<li class="mui-table-view-cell white">最大分期金额 <span class="mui-badge badge" data="maxFenQi">¥'+sui.rmoney(ui.Max)+"</span></li>");l.push('</ul><ul class="mui-table-view final"><li class="mui-table-view-cell">商品金额  <span class="mui-pull-right price" data="total">¥'+sui.rmoney(ui.TotalAmount)+"</span></li>");l.push('<li  class="mui-table-view-cell mui-hidden" data="AvailBal">账户余额<span class="mui-pull-right price" data="AvailBal">-¥0.00</span></li>');l.push('<li class="mui-table-view-cell mui-hidden" data="fenqi">分期金额<span class="mui-pull-right price" data="fenqi">-¥0.00</span></li>');l.push('<li class="mui-table-view-cell mui-hidden" data="squan">优惠券 <span class="mui-pull-right price" data="squan">-¥0.00</span></li>');l.push('<li class="mui-table-view-cell">运费<span class="mui-pull-right price">¥'+sui.rmoney(ui.DeliveryFee)+"</span></li></ul>");if(ui.isRent){l.push('<ul class="mui-table-view"><li class="mui-table-view-cell padb" data-v="zu" data="com"><a class="mui-navigate-right"><span class="mui-icon iconfont icon-duihao1"></span>同意《擦一擦租赁协议》</a></li></ul>')}if(ui.isDin){l.push('<ul class="mui-table-view"><li class="mui-table-view-cell padb" data-v="din" data="com"><a class="mui-navigate-right"><span class="mui-icon iconfont icon-duihao1"></span>同意《擦一擦预定租赁协议》</a></li></ul>')}ui.container.innerHTML=l.join("");mui(".mui-content .mui-switch")["switch"]();var j=ui.imgIdArr.length;for(var c=0;c<j;c++){cache.setImg(ui.imgIdArr[c].id,ui.imgIdArr[c].imgurl)}ui.payMoney.innerText="¥"+sui.rmoney(ui.TotalAmount+ui.DeliveryFee);ui.gCount.innerText="共"+ui.count+"件商品";ui.navbox.classList.remove("mui-hidden");sui.closewait(ui.w);if(!sui.IsNullOrEmpty(q.addrMessage)){a.confirm(q.addrMessage,"",["取消","确定"],function(i){if(i.index==0){return false}else{sui.open("../my/addAddr.html","addAddr.html",{op:"subOrder"})}})}}else{a.toast(g.Desc);sui.closewait(ui.w)}}else{a.toast("无法连接到服务器，请检查网络是否连接");sui.closewait(ui.w)}})},250)})})(mui);function selected(b,a,f,e,c){ui.addrId=b;ui.areaCode=c;localStorage.setItem("areaCode_cayica",c);var d='<p class="name">'+a+'<span class="mobile">'+f+'</span></p><p class="address"><span class="mui-icon iconfont icon-dizhi1"></span>'+e+"</p>";document.querySelector("a[data=addr]").innerHTML=d}function selectQuan(d,a,c){var b=0;ui.yajinId=d;ui.yajinPrice=c;ui.zujinId=a;if(!sui.IsNullOrEmpty(d)){b+=1}if(!sui.IsNullOrEmpty(a)){b+=1}if(b){document.querySelector("span[data=quan]").innerText="已选择"+b+"张优惠券";document.querySelector("li[data=squan]").classList.remove("mui-hidden")}else{document.querySelector("span[data=quan]").innerText="";document.querySelector("li[data=squan]").classList.add("mui-hidden")}countPrice()}function sendWay(b,a,c){ui.wayId=b;if(b==0){a="小擦物流"}ui.deliveryTime=c;if(b){document.querySelector("span[data=sendTime]").innerText=a+"："+c}}mui(ui.container).on("tap","a[data=addr]",function(){sui.open("selectAddr.html","selectAddr.html",{addrId:ui.addrId})});var countPrice=function(){var a=document.querySelector("div[data=toggle]");var d=0;var c=ui.TotalAmount+ui.DeliveryFee;if(ui.yajinPrice>0){document.querySelector("span[data=squan]").innerText="-¥"+sui.rmoney(ui.yajinPrice);c-=ui.yajinPrice;var b=Math.min(ui.finalMax-ui.yajinPrice,ui.AvailMax);if(b>0){ui.Max=b}else{ui.Max=0;ui.maxActive=false;document.querySelector("span[data=fenQiNum]").innerText="不可分期"}}else{ui.Max=Math.min(ui.finalMax,ui.AvailMax)}document.querySelector("span[data=maxFenQi]").innerText="¥"+sui.rmoney(ui.Max);if(ui.maxActive){c=c-ui.Max;document.querySelector("span[data=fenqi]").innerText="-¥"+sui.rmoney(ui.Max);document.querySelector("li[data=fenqi]").classList.remove("mui-hidden")}else{document.querySelector("span[data=fenqi]").innerText="-¥0.00"}if(a){if(a.classList.contains("mui-active")){if(c>ui.AvailBal){d=ui.AvailBal;c=c-ui.AvailBal}else{d=c>0?c:0;c=0}document.querySelector("span[data=AvailBal]").innerText="-¥"+sui.rmoney(d)}}ui.payMoney.innerText="¥"+sui.rmoney(c>0?c:0)};mui(ui.container).on("tap","li[data=com]",function(){var b=this.getAttribute("data-v");if(b=="time"){sui.open("sendTime.html","sendTime.html",{cartIds:ui.cartstr,wayId:ui.wayId,deliveryTime:ui.deliveryTime})}else{if(b=="quan"){var a="";if(!sui.IsNullOrEmpty(ui.yajinId)){a=ui.yajinId}if(!sui.IsNullOrEmpty(ui.zujinId)){a+=","+ui.zujinId}sui.open("quan.html","quan.html",{quanIds:a,cartstr:ui.cartstr})}else{if(b=="selectFenQi"){sui.open("selectFenQi.html","selectFenQi.html",{cartstr:ui.cartstr,yaJinQuanId:ui.yajinId,rentQuanId:ui.zujinId,fenQiNum:ui.qishu})}else{if(b=="zu"){sui.open("../help/zuxieyiMain.html","zuxieyiMain.html",{})}else{if(b=="din"){sui.open("../help/ydxieyiMain.html","ydxieyiMain.html",{})}}}}}});mui(ui.container).on("toggle","div[data=toggle]",function(a){if(a.detail.isActive){document.querySelector("span[data=AvailBal]").innerText="¥"+sui.rmoney(ui.AvailBal);document.querySelector("li[data=AvailBal]").classList.remove("mui-hidden");ui.IsUseAvailBal=true}else{document.querySelector("li[data=AvailBal]").classList.add("mui-hidden");ui.IsUseAvailBal=false}countPrice()});ui.subOrder.addEventListener("tap",function(){if(sui.IsNullOrEmpty(ui.addrId)){mui.toast("请选择收获地址");return}ui.w=sui.wait("请稍候...");var a={ShouHuoAddressId:ui.addrId,CartIds:ui.cartstr,DeliveryTime:ui.deliveryTime,YaJinQuanId:ui.yajinId,RentQuanId:ui.zujinId,IsUseAvailBal:ui.IsUseAvailBal,IsFenQi:ui.maxActive,FenQiAmount:ui.maxActive?ui.Max:0,FenQiNum:ui.qishu,DeliveryMethod:ui.wayId,OrderSource:ui.OrderSource};sui.request("Order/SubmitOrder",a,false,function(e){if(e){var c=e.IsPass;if(c){var d=plus.webview.currentWebview().opener();if(d){d.evalJS("pulldownRefresh();")}var b={PayWaterId:e.ReturnObject.PayWaterId,Amount:e.ReturnObject.Amount,PayTitle:e.ReturnObject.PayTitle,IsNeedPay:e.ReturnObject.IsNeedPay};if(b.IsNeedPay){sui.open("orderPay.html","orderPay.html",{PayWaterId:b.PayWaterId,Amount:b.Amount,PayTitle:b.PayTitle,payType:1});setTimeout(function(){var f=plus.webview.currentWebview();f.close("none",0)},500)}else{sui.open("paySuccess.html","paySuccess.html",{});setTimeout(function(){var f=plus.webview.currentWebview();f.close("none",0)},500)}sui.closewait(ui.w)}else{mui.toast(e.Desc);sui.closewait(ui.w)}}else{mui.toast("无法连接到服务器，请检查网络是否连接");sui.closewait(ui.w)}})});function fenQiNum(a){if(a==1){ui.maxActive=false;ui.qishu=1;document.querySelector("span[data=fenQiNum]").innerText="不分期"}else{ui.maxActive=true;ui.qishu=a;document.querySelector("span[data=fenQiNum]").innerText=a+"期"}countPrice()};