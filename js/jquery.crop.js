(function(a){a.fn.crop=function(d){var p={w:320,h:320,r:120,res:"",barHeight:50,touchBgColor:"#58d82c",isCircle:true,angle:0,initialScale:1,callback:function(o){}};var z=a.extend(p,d);a(this).html("");if(z.h<z.w){alert("容器区域高度须大于等于宽度！");return false}if(z.r>z.w*0.5){alert("请在手机上浏览或将浏览器宽度调整到高度二分之一以下！");return false}var m=a(this);if(!m.attr("id")){id="curbox"+Date.parse(new Date());m.attr("id",id)}else{id=m.attr("id")}var h=true;var c,F,g,i;var l=0,k=0,B=0,E=p.initialScale,q=0,n=0,u=0,C=0,s,D,j,A,f="",r;var e=new Object();var w=new Image();if(z.res==""){var b=a("<canvas />").attr({width:z.r*2,height:z.r*2}).get(0);cvt=b.getContext("2d");cvt.font="16px '微软雅黑'";cvt.fillStyle="#18b4ed";cvt.fillText("请先选择一张图片",z.r-64,z.r);z.res=b.toDataURL("image/png")}w.src=z.res;w.onload=function(){if(m.html()!=""){h=false;a(select_btn).text("重选");q=(z.w-z.r*2)*0.5;n=(z.h-z.r*2)*0.5}else{m.append('					<div id="cut-mask" style="width:'+z.w+"px;height:"+z.h+'px;position:relative;left:0px;top:0px;z-index:10;"><canvas id="canvas-mask"></canvas></div>					<div id="cut-img" style="width:'+z.w+"px;height:"+z.h+"px;position:relative;top:"+(-z.h)+"px;left:0px;background-image:url("+w.src+");background-size:"+w.width+"px "+w.height+'px;background-position:0px 0px;background-repeat:no-repeat;"></div><canvas id="temp-img" style="display:none;"></canvas>				');m.css({width:z.w+"px",height:z.h+"px",position:"relative",left:"0px",top:"0px",overflow:"hidden"});m.after('<div id="title_text" style="position:absolute;top:5px;left:0px;width:100%;line-height:40px;color:#fff;text-align:center;z-index:12;">设置头像</div><div style="height:'+p.barHeight+'px;width:100%;position:absolute;bottom:0px;"><input type="button" style="display:block;position:absolute;left:15px;bottom:15px;color:#18b4ed;z-index:99;background:#E8E8EC;width:70px;height:70px;text-align:center;border-radius:35px; border:0;font-family:微软雅黑;font-size:1em;" id="select_btn" value="选 择"/><input style="display:block;position:absolute;right:15px;bottom:15px;color:#fff;z-index:99;background:#18b4ed;width:70px;height:70px;text-align:center;border-radius:35px;border:0;font-family:微软雅黑;font-size:1em;" type="button" id="edit_finished" value="完 成" disabled="disabled"/><input type="file" id="selectImageFile" accept="image/*" capture="camera" style="height:0px;width:0px;border:0px;display:none;" /></div>');var L=document.getElementById("canvas-mask");var o=L.getContext("2d");L.width=z.w;L.height=z.h;o.beginPath();o.rect(0,0,z.w,z.h);o.globalAlpha=0.8;o.fill();o.closePath();z.h=h?z.h-z.barHeight:z.h;o.globalCompositeOperation="destination-out";o.beginPath();o.arc(z.w*0.5,z.h*0.5,z.r,0,(Math.PI/180)*360,false);o.fill();o.closePath();o.beginPath();o.rect((z.w-z.r*2)*0.5,(z.h-z.r*2)*0.5,z.r*2,z.r*2);o.fill();o.closePath();o.globalCompositeOperation="source-over";o.beginPath();o.lineWidth=1;o.strokeStyle="#ffffff";o.strokeRect((z.w-z.r*2)*0.5,(z.h-z.r*2)*0.5,z.r*2,z.r*2);o.fill();o.closePath();o.beginPath();o.moveTo((z.w-z.r*2)*0.5+z.r*2/3+0.5,(z.h-z.r*2)*0.5);o.lineTo((z.w-z.r*2)*0.5+z.r*2/3+0.5,(z.h-z.r*2)*0.5+z.r*2);o.moveTo((z.w-z.r*2)*0.5+2*z.r*2/3+0.5,(z.h-z.r*2)*0.5);o.lineTo((z.w-z.r*2)*0.5+2*z.r*2/3+0.5,(z.h-z.r*2)*0.5+z.r*2);o.moveTo((z.w-z.r*2)*0.5,(z.h-z.r*2)*0.5+z.r*2/3+0.5);o.lineTo((z.w-z.r*2)*0.5+z.r*2,(z.h-z.r*2)*0.5+z.r*2/3+0.5);o.moveTo((z.w-z.r*2)*0.5,(z.h-z.r*2)*0.5+2*z.r*2/3+0.5);o.lineTo((z.w-z.r*2)*0.5+z.r*2,(z.h-z.r*2)*0.5+2*z.r*2/3+0.5);o.stroke();o.closePath();s=w.width,D=w.height,j=w.width,A=w.height,e.l=(z.w-z.r*2)*0.5;e.t=(z.h-z.r*2)*0.5;e.r=(z.w-z.r*2)*0.5+z.r*2;e.b=(z.h-z.r*2)*0.5+z.r*2;c=document.getElementById(id);F=document.getElementById("cut-img");select_btn=document.getElementById("select_btn");g=document.getElementById("edit_finished");a(F).css({"background-position":(z.w-z.r*2)*0.5+"px "+(z.h-z.r*2)*0.5+"px"})}if(h){touch.on("#"+id,"touchstart",t);touch.on("#"+id,"drag",v);touch.on("#"+id,"dragend",y);touch.on("#"+id,"pinchstart",J);touch.on("#"+id,"pinch",I);touch.on("#"+id,"pinchend",H);a("#select_btn").click(function(){a("#selectImageFile").click()});a("#edit_finished").click(function(){G()});a("#selectImageFile").change(function(O){var N=O.target.files[0];if(window.FileReader){var M=new FileReader();M.onloadstart=function(P){document.getElementById("edit_finished").setAttribute("disabled","disabled");document.getElementById("loadding").style.display="";document.getElementById("backdrop").style.display=""};M.onloadend=function(Q){var P=new Image();P.src=Q.target.result;P.onload=function(){K(P)}};M.readAsDataURL(N)}})}function K(O){if(O.naturalWidth<z.r*2||O.naturalHeight<z.r*2){alert("图片尺寸太小，请重新选择不小于"+z.r*2+"*"+z.r*2+"像素大小的图片");document.getElementById("loadding").style.display="none";document.getElementById("backdrop").style.display="none"}else{var P=1;var N=x(O,P);var M=new Image();M.src=N;M.onload=function(){if(M.width>z.r*2*2&&M.height>z.r*2*2){s=j=M.width/2;D=A=M.height/2}else{s=j=M.width;D=A=M.height}w.src=N;a(F).css({"background-image":"url("+N+")","background-size":j+"px "+A+"px"});document.getElementById("loadding").style.display="none";document.getElementById("backdrop").style.display="none";document.getElementById("edit_finished").removeAttribute("disabled")}}}function x(P,S){var Q=1200,R=1200;if(P.width>P.height){imageWidth=Q;imageHeight=Math.round(R*(P.height/P.width))}else{if(P.width<P.height){imageHeight=R;imageWidth=Math.round(Q*(P.width/P.height))}else{imageWidth=Q;imageHeight=R}}S=imageWidth/P.width;var O=document.createElement("canvas");O.width=imageWidth;O.height=imageHeight;var N=O.getContext("2d");N.clearRect(0,0,O.width,O.height);N.drawImage(P,0,0,O.width,O.height);var M=O.toDataURL("image/png",S);return M}function t(M){M.preventDefault()}function v(M){M.preventDefault();if(h){return}u=q+M.x;C=n+M.y;if(u>e.l){u=e.l}if(C>e.t){C=e.t}if(u+j<e.r){u=e.r-j+1}if(C+A<e.b){C=e.b-A+1}a("#cut-img").css({"background-position":u+"px "+C+"px","background-repeat":"no-repeat"})}function y(M){q=u;n=C}function J(M){M.preventDefault()}function I(M){M.preventDefault();if(h){return}E=M.scale;E=E>3?3:E;E=E<0?0:E;if(s*E>=z.r*2&&D*E>=z.r*2){j=s*E;A=D*E;u=q*E;C=n*E;u=u-(j-s)/2;C=C-(A-D)/2;if(u>e.l){u=e.l}if(C>e.t){C=e.t}if(u+j<e.r){u=e.r-j+1}if(C+A<e.b){C=e.b-A+1}a("#cut-img").css({"background-size":j+"px "+A+"px","background-position":u+"px "+C+"px","background-repeat":"no-repeat"})}}function H(N){var O=a(F).css("background-size");var M=O.split(" ");q=parseInt(a(F).css("background-position-x"));n=parseInt(a(F).css("background-position-y"));s=parseInt(M[0]);D=parseInt(M[1])}function G(){if(h){alert("请先选择一张图片");return}var Q=a("<canvas />").attr({width:z.r*2,height:z.r*2}).get(0);canvasContext=Q.getContext("2d");canvasContext.fillStyle="#eee";canvasContext.fillRect(0,0,Q.width,Q.height);var N=(z.w*0.5-z.r-q)*w.width/s,S=(z.h*0.5-z.r-n)*w.height/D,O=z.r*2*w.width/s,R=z.r*2*w.height/D;var M=ny=nw=nh=0;var P=dy=dw=dh=0;if(N<0){M=0;if(N+O<w.width){nw=N+O}else{nw=w.width}}else{M=N;if(N+O<w.width){nw=O}else{nw=w.width-N}}if(S<0){ny=0;if(S+R<w.height){nh=S+R}else{nh=w.height}}else{ny=S;if(S+R<w.height){nh=R}else{nh=w.height-S}}P=(N<0?-N:0)*s/w.width;dy=(S<0?-S:0)*D/w.height;dw=(nw*s/w.width<z.r*2?nw*s/w.width:z.r*2);dh=(nh*D/w.height<z.r*2?nh*D/w.height:z.r*2);canvasContext.drawImage(w,M,ny,nw,nh,P,dy,dw,dh);z.callback(Q.toDataURL())}}}})(jQuery);