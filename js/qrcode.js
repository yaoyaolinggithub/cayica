var ui={container:sui.gel("container"),shares:{},saveLocal:sui.gel("saveLocal"),backdrop:sui.gel("mui-backdrop")};(function(a){a.plusReady(function(){a.init({gestureConfig:{longtap:true}});setTimeout(function(){refreshQrcode();plus.share.getServices(function(d){if(d&&d.length>0){for(var c=0;c<d.length;c++){var b=d[c];ui.shares[b.id]=b}}},function(){mui.toast("获取分享服务列表失败")})},260)})})(mui);var updateQrCode=function(a){var b={render:"image",ecLevel:"M",minVersion:6,color:"#000",bgColor:"#fff",text:a,size:460,radius:0.5,quiet:1,mode:4,label:$("#label").val(),labelsize:0.1,fontname:"Ubuntu",fontcolor:"#ff9818",image:$("#img-buffer")[0],imagesize:0.2};$("#container").empty().qrcode(b);ui.container.classList.add("sui-fadeIn")};var utf16to8=function(e){var b,d,a,f;b="";a=e.length;for(d=0;d<a;d++){f=e.charCodeAt(d);if((f>=1)&&(f<=127)){b+=e.charAt(d)}else{if(f>2047){b+=String.fromCharCode(224|((f>>12)&15));b+=String.fromCharCode(128|((f>>6)&63));b+=String.fromCharCode(128|((f>>0)&63))}else{b+=String.fromCharCode(192|((f>>6)&31));b+=String.fromCharCode(128|((f>>0)&63))}}}return b};function refreshQrcode(){ui.w=sui.wait("请稍候...");sui.request("User/GetQrCodeUrl",{},true,function(b){if(b){var a=b.IsPass;if(a){updateQrCode(utf16to8(b.ReturnObject));createQrcode();sui.closewait(ui.w)}else{mui.toast(b.Desc);sui.closewait(ui.w)}}else{mui.toast("无法连接到服务器，请检查网络是否连接");sui.closewait(ui.w)}})}var base64=null;ui.container.addEventListener("longtap",function(){base64=this.src;ui.saveLocal.style.display="block";ui.backdrop.style.display="block"});ui.saveLocal.addEventListener("tap",function(){plus.gallery.save("_downloads/qrcode.png",function(){mui.toast("保存图片到相册成功")},function(){mui.toast("保存图片到相册失败")});ui.saveLocal.style.display="none";ui.backdrop.style.display="none"});ui.backdrop.addEventListener("tap",function(){ui.saveLocal.style.display="none";ui.backdrop.style.display="none"});var shareCardPicture=function(b){var a="_downloads/qrcode.png";if(b){a="_downloads/sharedLogo.png"}plus.io.resolveLocalFileSystemURL(a,function(c){pic.src=c.toLocalURL();pic.realUrl=a},function(c){mui.toast("读取二维码文件错误："+c.message)})};var shareMessage=function(b,a){var c={content:"擦一擦一站式租赁平台！",extra:{scene:a}};if(pic&&pic.realUrl){c.pictures=[pic.realUrl]}b.send(c,function(){},function(d){})};var shareAction=function(c,a){var b=null;if(!c||!(b=ui.shares[c])){mui.toast("无效的分享服务！");return}if(b.authenticated){shareMessage(b,a)}else{b.authorize(function(){shareMessage(b,a)},function(d){mui.toast("认证授权失败")})}};var createQrcode=function(){var a=mui("img")[0].src;var b=new plus.nativeObj.Bitmap("qrcode");b.loadBase64Data(a,function(){b.save("_downloads/qrcode.png",{overwrite:true,quality:100},function(){plus.zip.compressImage({src:"_downloads/qrcode.png",dst:"_downloads/sharedLogo.png",quality:100,overwrite:true},function(c){shareCardPicture(true)},function(c){shareCardPicture(false)});b.clear()},function(){b.clear()})},function(){b.clear()})};mui("body").on("tap","a[class=share_li]",function(){var b=[{id:"weixin",ex:"WXSceneSession"},{id:"weixin",ex:"WXSceneTimeline"},{id:"qq"}];var a=parseInt(this.getAttribute("sid"));shareAction(b[a].id,b[a].ex);mui("#Share").popover("toggle")});