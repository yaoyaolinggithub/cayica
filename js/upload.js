var setOption=null,rpath=null;window.onload=function(){var a=document.getElementById("img-container");a.style.height=MyCropper.change_screen_height();a.style.width=MyCropper.change_screen_width();MyCropper.initCropper("../images/upload.png")};mui.plusReady(function(){mui("body").on("tap","li[data=rotate]",function(b){var a=parseInt(this.getAttribute("data-value"));MyCropper.rotate_image(a)});mui("body").on("tap","li[data=operater]",function(d){var c=this.getAttribute("data-value");if(c=="chooise"){var a=[{title:"拍照"},{title:"从相册选择"}];plus.nativeUI.actionSheet({title:"选择照片",cancel:"取消",buttons:a},function(h){var f=h.index;switch(f){case 0:break;case 1:var g=plus.camera.getCamera();g.captureImage(function(k){var e=MyCropper.waitting();var i="file://"+decodeURIComponent(plus.io.convertLocalFileSystemURL(k));var j="_documents/"+new Date().getTime()+".jpg";MyCropper.compressImage(i,j,function(m){var l="";if(m.success){l="file://"+plus.io.convertLocalFileSystemURL(m.path)}else{l=m.path}MyCropper.replace_image(l,function(n){MyCropper.closewait(e)})})},function(e){});break;case 2:plus.gallery.pick(function(j){var e=MyCropper.waitting();var i="_documents/"+new Date().getTime()+".jpg";MyCropper.compressImage(decodeURIComponent(j),i,function(l){var k="";if(l.success){k="file://"+plus.io.convertLocalFileSystemURL(l.path)}else{k=l.path}MyCropper.replace_image(k,function(m){MyCropper.closewait(e)})})},function(e){},null);break}})}else{if(c=="upload"){if(setOption.path=="../images/upload.png"){mui.toast("请选择图片");return}var b=MyCropper.waitting();MyCropper.operateImage.operate_image(setOption,MyCropper.operate_image_callback,b)}}})});var MyCropper={waitting:function(){return plus.nativeUI.showWaiting("处理中，请稍候...",{back:"close"})},closewait:function(a){a.close();a=null},change_screen_height:function(){return(document.body.clientHeight-document.querySelector("nav").clientHeight-document.querySelector("header").clientHeight)+"px"},change_screen_width:function(){return document.body.clientWidth+"px"},initCropper:function(a){document.getElementById("operate-img").src=a;setOption={path:a,dst:"myCropperPhoto",width:"600px",height:"auto",rotate:0,clip:{top:"0%",left:"0%",width:"100%",height:"100%"}};$("#operate-img").cropper({aspectRatio:1/1,responsive:true,crop:function(d){var b=$("#operate-img").cropper("getImageData").naturalWidth;var c=$("#operate-img").cropper("getImageData").naturalHeight;if(d.rotate==0){setOption.width="600px";setOption.height="auto";setOption.clip["left"]=(Math.round(d.x/b*100)).toString()+"%";setOption.clip["top"]=(Math.round(d.y/c*100)).toString()+"%";setOption.clip["width"]=(Math.round(d.width/b*100)).toString()+"%";setOption.clip["height"]=(Math.round(d.height/c*100)).toString()+"%"}else{if(d.rotate==90){setOption.width="auto";setOption.height="600px";setOption.clip["left"]=(Math.round(d.y/b*100)).toString()+"%";setOption.clip["top"]=(Math.round((c-d.x-d.width)/c*100)).toString()+"%";setOption.clip["width"]=(Math.round(d.height/b*100)).toString()+"%";setOption.clip["height"]=(Math.round(d.width/c*100)).toString()+"%"}else{if(d.rotate==180){setOption.width="600px";setOption.height="auto";setOption.clip["left"]=(Math.round((b-d.x-d.width)/b*100)).toString()+"%";setOption.clip["top"]=(Math.round((c-d.y-d.height)/c*100)).toString()+"%";setOption.clip["width"]=(Math.round(d.width/b*100)).toString()+"%";setOption.clip["height"]=(Math.round(d.height/c*100)).toString()+"%"}else{setOption.width="auto";setOption.height="600px";setOption.clip["left"]=(Math.round((b-d.y-d.height)/b*100)).toString()+"%";setOption.clip["top"]=(Math.round(d.x/c*100)).toString()+"%";setOption.clip["width"]=(Math.round(d.height/b*100)).toString()+"%";setOption.clip["height"]=(Math.round(d.width/c*100)).toString()+"%"}}}setOption.rotate=d.rotate}})},rotate_image:function(a){$("#operate-img").cropper("rotate",a)},replace_image:function(a,b){$("#operate-img").cropper("replace",a);setOption.path=a;b(true)},compress_image_callback:function(d){var c="file://"+plus.io.convertLocalFileSystemURL(d.data["target"]);var b=localStorage.getItem("CAYICA_TOKEN");var a=plus.uploader.createUpload("https://app.cayica.com/User/Upload",{method:"POST"},function(g,e){if(e==200){var k=JSON.parse(g.responseText);var h=k.IsPass;if(h){var f=k.ReturnObject;var i=plus.webview.getWebviewById("info.html");var j=plus.webview.getWebviewById("my.html");if(i){i.evalJS('changeImg("'+f+'")')}if(j){j.evalJS('changeImg("'+f+'")')}MyCropper.closewait(d.w);mui.toast("头像设置成功！");plus.webview.currentWebview().close()}else{MyCropper.closewait(d.w);mui.toast("头像设置失败，请稍后再试！")}}else{MyCropper.closewait(d.w);mui.toast("网络不给力，请检查网络设置")}});a.setRequestHeader("Token",b);a.addFile(c,{key:"pic"});a.start()},operate_image_callback:function(b){if(b.code==0){var a={path:b.path,w:b.w};MyCropper.operateImage.compress_image(a,MyCropper.compress_image_callback)}else{mui.toast("图片处理失败，请稍候再试");MyCropper.closewait(b.w)}},removeFile:function(a,b){plus.io.resolveLocalFileSystemURL(a,function(c){c.remove(function(d){b(true)},function(d){b(false)})},function(c){b(false)})},compressImage:function(b,a,c){MyCropper.removeFile(rpath,function(e){plus.zip.compressImage({src:b,dst:a,quality:40,overwrite:true,format:"jpg",width:"100%",height:"auto"},function(d){rpath=a;var f={path:a,success:true};c(f)},function(f){var d={path:b,success:false};c(d)})})}};(function(b,a){b.operateImage={};b.operateImage.COMPRESS_IMAGE_LIMIT=60000;b.operateImage.compress_image=function(d,c){var e="_documents/myCompressImage.jpg";plus.io.resolveLocalFileSystemURL(d.path,function(f){f.file(function(h){if(h.size>b.operateImage.COMPRESS_IMAGE_LIMIT){plus.zip.compressImage({src:d.path,dst:e,quality:Math.round(b.operateImage.COMPRESS_IMAGE_LIMIT/h.size*100),overwrite:true,format:"jpg",width:"100%",height:"auto"},function(k){var j={code:0,data:{target:e},w:d.w};c(j)},function(j){var i={code:2,w:d.w};c(i)})}else{var g={code:0,data:{target:d.path},w:d.w};c(g)}})},function(g){var f={code:1,w:d.w};c(f)})};b.operateImage.operate_image=function(d,f,c){var e="_documents/"+d.dst+".jpg";plus.io.resolveLocalFileSystemURL(d.path,function(g){g.file(function(h){plus.zip.compressImage({src:d.path,dst:e,quality:50,overwrite:true,format:"jpg",width:d.width,height:d.height,rotate:d.rotate,clip:{top:d.clip.top,left:d.clip.left,width:d.clip.width,height:d.clip.height}},function(k){var j={code:0,path:e,w:c};f(j)},function(j){var i={code:2,w:c};f(i)})})},function(h){var g={code:1,w:c};f(g)})}}(MyCropper,document));