var ui={container:sui.gel("container"),checkAll:sui.gel("checkAll"),totalPrice:sui.gel("totalPrice"),subJieSuan:sui.gel("subJieSuan"),delCarts:sui.gel("delCarts"),shopping:sui.gel("shopping"),tips:sui.gel("tips"),w:null,index:1,nonebox:sui.gel("nonebox"),shoppingOrLogin:1,imgIdArr:[],isRequest:null,detail:true,navbox:sui.gel("navbox"),first:false,loopPullDown:null};(function(a){a.init({pullRefresh:{container:"#pullrefresh",down:{callback:pulldownRefresh},up:{callback:pullupRefresh}},gestureConfig:{longtap:true}})})(mui);window.addEventListener("shoppingcart",function(a){if(!ui.first){setTimeout(function(){mui("#pullrefresh").pullRefresh().pullupLoading();ui.first=true},120)}else{pulldownRefresh()}});var noneFunc=function(a){if(mui.os.ios){mui("#pullrefresh").pullRefresh().scrollTo(0,0,0)}if(a){ui.shoppingOrLogin=1;ui.tips.innerText="您的购物还是空的呢，";ui.shopping.innerText="去逛逛吧"}else{ui.shoppingOrLogin=0;ui.tips.innerText="您还没有登录，";ui.shopping.innerText="去登录"}ui.nonebox.classList.remove("mui-hidden")};var template=function(p){var c=1,i=p.IsValid;if((p.ProductType==1&&p.SaleType==2)||!i){c=0}var e=sui.unique(6);ui.imgIdArr.push({id:e,imgurl:p.ProductImg});var o='<div class="mui-ellipsis guige" data="set" data-v="'+p.Id+'" data-href="'+c+'"><a>';var g=p.ProductAttribute;if(!sui.IsNullOrEmpty(g)){g=JSON.parse(g||"[]");var h=g.length;for(var f=0;f<h;f++){if(f==2){break}o+=g[f].AttrVal+" "}}var d='<a class="mui-icon mui-icon-arrowright mui-pull-right '+(ui.detail?"mui-hidden":"")+'"></a>';if(!i){d=""}o+="</a>"+d+"</div>";var b="押金";switch(p.SaleType){case 2:b="售价";break;case 3:b="定金";break;default:break}var a='<div class="mui-numbox" data-numbox-min="1" data-numbox-max="99"><button class="mui-btn mui-btn-numbox-minus" type="button">-</button>';a+='<input  class="mui-input-numbox" type="number" value="'+p.BuyNum+'"  data-v="'+p.Price+'" data-Id="'+p.Id+'" readonly="readonly"/><button class="mui-btn mui-btn-numbox-plus" type="button">+</button></div>';var l='<input type="checkbox" value="'+p.Id+'" data="checkbox"/>';var n="",k="";if(!i){a='<div class="mui-numbox-self">商品失效 <span class="gray">×'+p.BuyNum+"</span></div>";l='<input type="checkbox" value="'+p.Id+'"  disabled="disabled" data="disabled"/>';n="gray";k="opcity"}var m=['<div class="mui-slider-right mui-disabled"><a class="mui-btn mui-btn-red" data="del">删除</a></div>','<div class="mui-table mui-slider-handle" data-Id="'+p.Id+'" data-href="'+c+'" data-v="'+p.SkuId+'"><div class="mui-table-cell mui-col-xs-2 mui-text-left"><div class="mui-checkbox">'+l+"</div>",'<img class="mui-pull-right border '+k+'" src="images/hand.png" id="'+e+'" data="detail" /></div><div class="mui-table-cell mui-col-xs-10"><div class="mui-ellipsis-2 '+n+'" data="detail">'+p.ProductName+"</div>",o+'<div class="bottom-box"><span class="yajin '+n+'" data="set"> '+b+" ¥"+sui.rmoney(p.Price)+"</span>"+a+"</div></div></div></li>"].join("");return m};function pulldownRefresh(){clearTimeout(ui.loopPullDown);setTimeout(function(){if(sui.isLogin()){sui.request("Order/MyCart",{pageIndex:1},true,function(e){if(e){var j=e.IsPass;if(j){var a=e.ReturnList?e.ReturnList.length:0;if(a>0){ui.imgIdArr=[];ui.nonebox.classList.add("mui-hidden");ui.container.innerHTML="";var h=sui.fragment();for(var f=0;f<a;f++){var l={Id:e.ReturnList[f].Id,ProductImg:e.ReturnList[f].ProductImg,ProductName:e.ReturnList[f].ProductName,ProductAttribute:e.ReturnList[f].ProductAttribute,SaleType:e.ReturnList[f].SaleType,BuyNum:e.ReturnList[f].BuyNum,Price:e.ReturnList[f].Price,ProductType:e.ReturnList[f].ProductType,ProductId:e.ReturnList[f].ProductId,SkuId:e.ReturnList[f].SkuId,IsValid:e.ReturnList[f].IsValid};var k=document.createElement("li");k.className="mui-table-view-cell";k.setAttribute("data","del");k.innerHTML=template(l);h.appendChild(k)}ui.container.appendChild(h);ui.container.classList.remove("mui-hidden");ui.navbox.classList.remove("mui-hidden");mui(".mui-numbox").numbox();var g=ui.imgIdArr.length;for(var c=0;c<g;c++){cache.setImg(ui.imgIdArr[c].id,ui.imgIdArr[c].imgurl)}ui.index=2;mui("#pullrefresh").pullRefresh().endPulldownToRefresh();ui.loopPullDown=setTimeout(function(){mui("#pullrefresh").pullRefresh().enablePullupToRefresh();mui("#pullrefresh").pullRefresh().refresh(true)},1000);computedPrice()}else{mui("#pullrefresh").pullRefresh().endPulldownToRefresh();mui("#pullrefresh").pullRefresh().disablePullupToRefresh();ui.navbox.classList.add("mui-hidden");ui.container.classList.add("mui-hidden");noneFunc(1)}var d=e.Count;var b=plus.webview.currentWebview().parent();if(b){b.evalJS('goodsNum("'+d+'")')}}else{mui.toast(e.Desc);mui("#pullrefresh").pullRefresh().endPulldownToRefresh()}}else{mui.toast("无法连接到服务器，请检查网络是否连接");mui("#pullrefresh").pullRefresh().endPulldownToRefresh()}})}else{noneFunc(0);ui.container.classList.add("mui-hidden");ui.navbox.classList.add("mui-hidden");mui("#pullrefresh").pullRefresh().endPulldownToRefresh();mui("#pullrefresh").pullRefresh().disablePullupToRefresh()}sui.closewait(ui.w)},500)}function pullupRefresh(){setTimeout(function(){if(sui.isLogin()){sui.request("Order/MyCart",{pageIndex:ui.index},true,function(c){if(c){var g=c.IsPass;if(g){var a=c.ReturnList.length;if(a>0){ui.imgIdArr=[];var f=sui.fragment();for(var d=0;d<a;d++){var j={Id:c.ReturnList[d].Id,ProductImg:c.ReturnList[d].ProductImg,ProductName:c.ReturnList[d].ProductName,ProductAttribute:c.ReturnList[d].ProductAttribute,SaleType:c.ReturnList[d].SaleType,BuyNum:c.ReturnList[d].BuyNum,Price:c.ReturnList[d].Price,ProductType:c.ReturnList[d].ProductType,ProductId:c.ReturnList[d].ProductId,SkuId:c.ReturnList[d].SkuId,IsValid:c.ReturnList[d].IsValid};var h=document.createElement("li");h.className="mui-table-view-cell";h.setAttribute("data","del");h.innerHTML=template(j);f.appendChild(h)}ui.container.appendChild(f);if(ui.index==1){ui.nonebox.classList.add("mui-hidden");ui.container.classList.remove("mui-hidden");ui.navbox.classList.remove("mui-hidden")}mui(".mui-numbox").numbox();var e=ui.imgIdArr.length;for(var b=0;b<e;b++){cache.setImg(ui.imgIdArr[b].id,ui.imgIdArr[b].imgurl)}ui.imgIdArr=[];ui.index++;mui("#pullrefresh").pullRefresh().endPullupToRefresh(false);computedPrice()}else{if(ui.index==1){mui("#pullrefresh").pullRefresh().endPullupToRefresh(true);mui("#pullrefresh").pullRefresh().disablePullupToRefresh();ui.container.classList.add("mui-hidden");ui.navbox.classList.add("mui-hidden");noneFunc(1)}else{mui("#pullrefresh").pullRefresh().endPullupToRefresh(true)}}}else{mui.toast(c.Desc);mui("#pullrefresh").pullRefresh().endPullupToRefresh(false)}}else{mui.toast("无法连接到服务器，请检查网络是否连接！");mui("#pullrefresh").pullRefresh().endPullupToRefresh(false)}})}else{noneFunc(0);ui.container.classList.add("mui-hidden");ui.navbox.classList.add("mui-hidden");mui("#pullrefresh").pullRefresh().endPullupToRefresh(true);mui("#pullrefresh").pullRefresh().disablePullupToRefresh()}},500)}var computedPrice=function(){var b=ui.container.querySelectorAll('input[data="checkbox"]').length;var d=ui.container.querySelectorAll('input[data="checkbox"]:checked').length;if(d){if(b==d){ui.checkAll.checked=true}else{ui.checkAll.checked=false}var e=[].slice.call(ui.container.querySelectorAll('input[data="checkbox"]:checked'));var a=0,c=0;e.forEach(function(j,g){var h=j.parentNode.parentNode.parentNode;var k=h.querySelector(".mui-input-numbox");var f=parseInt(k.value);var i=f*parseFloat(k.getAttribute("data-v"));c+=f;a+=i});ui.totalPrice.innerText="合计：¥"+sui.rmoney(a);ui.subJieSuan.innerText="去结算("+c+")"}else{ui.checkAll.checked=false;ui.totalPrice.innerText="合计：¥0.00";ui.subJieSuan.innerText="去结算(0)"}};var selectAll=function(a){var b=[].slice.call(ui.container.querySelectorAll('input[data="checkbox"]'));if(a){b.forEach(function(d,c){d.checked=true});computedPrice()}else{b.forEach(function(d,c){d.checked=false});ui.totalPrice.innerText="合计：¥0.00";ui.subJieSuan.innerText="去结算(0)"}};mui("#navbox").on("change","input[type=checkbox]",function(){var a=this;if(a.checked){selectAll(true)}else{selectAll(false)}});mui("#container").on("change","input[data=checkbox]",function(){setTimeout(function(){computedPrice()},200)});var getCartNum=function(){sui.request("Order/GetCartProductNum",{},true,function(d){if(d){var c=d.IsPass;if(c){var a=d.ReturnObject;var b=plus.webview.getWebviewById("main.html");if(b){b.evalJS('goodsNum("'+a+'")')}}else{mui.toast(d.Desc)}}else{mui.toast("无法连接到服务器，请检查网络是否连接")}})};var modifyCartNum=function(b,a){sui.post("Order/ModifyCartNum",{cartId:b,num:a},function(d){if(d){var c=d.IsPass;if(c){computedPrice();getCartNum()}else{mui.toast(d.Desc);pulldownRefresh()}}else{mui.toast("无法连接到服务器，请检查网络是否连接")}})};mui(ui.container).on("change",'input[type="number"]',function(){var a=this;clearTimeout(ui.isRequest);ui.isRequest=setTimeout(function(){var b=a.value.trim();var c=a.getAttribute("data-Id");modifyCartNum(c,b)},300)});function editCarts(){ui.detail=false;var a=[].slice.call(ui.container.querySelectorAll(".mui-icon-arrowright"));a.forEach(function(c,b){c.classList.remove("mui-hidden")});ui.totalPrice.classList.add("mui-hidden");ui.subJieSuan.classList.add("mui-hidden");ui.delCarts.classList.remove("mui-hidden")}function toggle(){ui.detail=true;var a=[].slice.call(ui.container.querySelectorAll(".mui-icon-arrowright"));a.forEach(function(c,b){c.classList.add("mui-hidden")});computedPrice();ui.delCarts.classList.add("mui-hidden");ui.totalPrice.classList.remove("mui-hidden");ui.subJieSuan.classList.remove("mui-hidden")}var redirectUrl=function(c){if(ui.detail){var b=c.getAttribute("data-v");sui.open("goods/goodsDetailMain.html","goodsDetailMain.html",{pid:b})}else{var a=c.getAttribute("data-href");if(a==1){var b=c.getAttribute("data-Id");sui.open("editSpec.html","editSpec.html",{cartId:b})}else{mui.toast("该商品不能编辑哦")}}};mui(ui.container).on("tap","img[data=detail]",function(){var a=this.parentNode.parentNode;redirectUrl(a)});mui(ui.container).on("tap","div[data=detail]",function(){var a=this.parentNode.parentNode;redirectUrl(a)});mui(ui.container).on("tap","span[data=set]",function(){var a=this.parentNode.parentNode.parentNode;redirectUrl(a)});mui(ui.container).on("tap","div[data=set]",function(){var a=this.parentNode.parentNode;redirectUrl(a)});var deleteCart=function(a,d){var c=0;if(a==1){c=ui.container.querySelectorAll('input[data="checkbox"]:checked').length}else{c=1}if(c){ui.w=sui.wait("请稍候...");var e=null;if(a==1){e=[].slice.call(ui.container.querySelectorAll('input[data="checkbox"]:checked'))}else{e=[].slice.call(d.querySelectorAll('input[type="checkbox"]'))}var b="";e.forEach(function(g,f){var h=g.value;b+=h+","});b=b.substring(0,b.length-1);sui.post("Order/DelCart",{cartids:b},function(g){if(g){var f=g.IsPass;if(f){pulldownRefresh()}else{mui.toast(g.Desc);sui.closewait(ui.w)}}else{mui.toast("无法连接到服务器，请检查网络是否连接");sui.closewait(ui.w)}})}else{mui.toast("至少选择一件商品哦")}};mui(ui.container).on("longtap","li[data=del]",function(){var a=this;var b=[{title:"删除",style:"destructive"}];plus.nativeUI.actionSheet({cancel:"取消",buttons:b},function(c){if(c.index==1){deleteCart(2,a)}})});mui(ui.container).on("tap","a[data=del]",function(){var a=this.parentNode.parentNode;deleteCart(2,a)});ui.delCarts.addEventListener("tap",function(){deleteCart(1,null)});ui.subJieSuan.addEventListener("tap",function(){var d=ui.container.querySelectorAll('input[data="checkbox"]:checked');var c=d.length;if(c){var b="";for(var a=0;a<c;a++){b+=d[a].value+","}b=b.substring(0,b.length-1);sui.open("orderProcess/subOrder.html","subOrder.html",{cartIds:b})}else{mui.toast("至少选择一件商品哦")}});ui.shopping.addEventListener("tap",function(){if(ui.shoppingOrLogin==1){var a=plus.webview.getWebviewById("main.html");if(a){mui.fire(a,"GoCategory");setTimeout(function(){a.show()},200)}}else{sui.open("login.html","login.html",{})}});